<launch>

     <arg name="rtabmapviz"              default="true" />
     <arg name="gui_cfg"                 default="~/.ros/rtabmap_gui.ini" />

     <arg name="frame_id"                default="base_link" />
     <arg name="rgb_topic"               default="/camera/color/image_raw" />
     <arg name="camera_info_topic"       default="/camera/color/camera_info" />
     <arg name="depth_topic"             default="/camera/depth/image_rect_raw" />
     <arg name="imu_topic"               default="/imu/data/filtered" />
     <arg name="imu_ignore_acc"          default="true" />
     <arg name="imu_remove_gravitational_acceleration" default="true" />
     <arg name="wait_for_transform"      default="0.2"/>

     <!-- Localization-only mode -->
     <arg name="localization"      default="false"/>
     <arg     if="$(arg localization)" name="rtabmap_args"  default=""/>
     <arg unless="$(arg localization)" name="rtabmap_args"  default="--delete_db_on_start"/>
     <!-- Feature Extraction Method -->
     <arg name="feature_method"      default="6"/>   <!--      0=SURF
                                                                 1=SIFT
                                                                 2=ORB
                                                                 3=FAST/FREAK
                                                                 4=FAST/BRIEF
                                                                 5=GFTT/FREAK
                                                                 6=GFTT/BRIEF
                                                                 7=BRISK
                                                                 8=GFTT/ORB
                                                                 9=KAZE
                                                                 10=ORB-OCTREE.
                                                            -->

     <group ns="rtabmap">
          <!-- Visual Odometry -->
          <node pkg="rtabmap_ros" type="rgbd_odometry" name="visual_odometry" output="screen" args="$(arg rtabmap_args)">
               <remap from="rgb/image"       to="$(arg rgb_topic)"/>
               <remap from="depth/image"     to="$(arg depth_topic)"/>
               <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
               <remap from="odom"            to="/vo"/>

               <param name="frame_id"               type="string" value="$(arg frame_id)"/>
               <param name="publish_tf"             type="bool"   value="false"/>
               <param name="publish_null_when_lost" type="bool"   value="true"/>
               <param name="guess_from_tf"          type="bool"   value="true"/>

               <param name="Odom/FillInfoData"      type="string" value="true"/>
               <param name="Odom/ResetCountdown"    type="string" value="1"/>
               <param name="Vis/FeatureType"        type="string" value="$(arg feature_method)"/>
               <param name="OdomF2M/MaxSize"        type="string" value="1000"/>
               <param name="GFTT/MinDistance"       type="string" value="5"/>
               <param name="Odom/Strategy"          value="2"/>
               <param name="Odom/FilteringStrategy" value="1"/>
          </node>

          <!-- SLAM -->
          <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="screen" args="$(arg rtabmap_args)">
               <param name="frame_id"        type="string" value="$(arg frame_id)"/>
               <remap from="rgb/image"       to="$(arg rgb_topic)"/>
               <remap from="depth/image"     to="$(arg depth_topic)"/>
               <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
               <remap from="odom"            to="/odometry/filtered"/>

               <param name="Kp/DetectorStrategy"    type="string" value="$(arg feature_method)"/> <!-- use same features as odom -->
               <!-- localization mode -->
               <param name="Mem/InitWMWithAllNodes" type="string" value="$(arg localization)"/>
               <param     if="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="false"/>
               <param unless="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="true"/>
          </node>

          <!-- GUI -->
          <node if="$(arg rtabmapviz)" pkg="rtabmap_ros" type="rtabmapviz" name="rtabmapviz" args="-d $(arg gui_cfg)">
               <param name="subscribe_depth"  type="bool" value="true"/>
               <param name="subscribe_rgbd"       type="bool"   value="false"/>
               <param name="subscribe_stereo"     type="bool"   value="false"/>
               <param name="subscribe_scan"       type="bool"   value="false"/>
               <param name="subscribe_scan_cloud" type="bool"   value="false"/>
               <param name="subscribe_odom_info"  type="bool" value="true"/>
               <param name="frame_id"             type="string" value="$(arg frame_id)"/>
               <param name="odom_frame_id"        type="string" value=""/>
               <param name="wait_for_transform_duration" type="double"   value="$(arg wait_for_transform)"/>

               <remap from="rgb/image"       to="$(arg rgb_topic)"/>
               <remap from="depth/image"     to="$(arg depth_topic)"/>
               <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
               <remap from="odom"            to="/odometry/filtered"/>
          </node>
     </group>


     <!-- Odometry fusion (EKF), refer to demo launch file in robot_localization for more info -->
     <node pkg="robot_localization" type="ekf_localization_node" name="ekf_localization" clear_params="true" output="screen">
          <rosparam command="load" file="$(find swanson_algorithms)/config/rtabmap_fusion.yaml" />

          <param name="base_link_frame" value="$(arg frame_id)"/>
          <param name="odom0" value="/vo"/>
          <param name="imu0" value="$(arg imu_topic)"/>
          <param name="imu0_remove_gravitational_acceleration" value="$(arg imu_remove_gravitational_acceleration)"/>

          <!-- The order of the values is
               x, y, z,
               roll, pitch, yaw,
               vx, vy, vz,
               vroll, vpitch, vyaw,
               ax, ay, az.
          -->
          <rosparam param="odom0_config">
               [true, true, true,
                true, true, true,
                true, true, true,
                false, false, false,
                false, false, false]
          </rosparam>

          <rosparam     if="$(arg imu_ignore_acc)" param="imu0_config">
               [false, false, false,
               true,  true,  true,
               false, false, false,
               true,  true,  true,
               false,  false,  false
               ]
          </rosparam>
          <rosparam unless="$(arg imu_ignore_acc)" param="imu0_config">
               [false, false, false,
               true,  true,  true,
               false, false, false,
               true,  true,  true,
               true,  true,  true
               ]
          </rosparam>

          <!-- The values are ordered as
               x, y, z,
               roll, pitch, yaw,
               vx, vy, vz,
               vroll, vpitch, vyaw,
               ax, ay, az.
          -->
          <rosparam param="process_noise_covariance">
               [0.0005, 0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
               0,    0.0005, 0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
               0,    0,    0.006, 0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
               0,    0,    0,    0.003, 0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
               0,    0,    0,    0,    0.003, 0,    0,     0,     0,    0,    0,    0,    0,    0,    0,
               0,    0,    0,    0,    0,    0.006, 0,     0,     0,    0,    0,    0,    0,    0,    0,
               0,    0,    0,    0,    0,    0,    0.0025, 0,     0,    0,    0,    0,    0,    0,    0,
               0,    0,    0,    0,    0,    0,    0,     0.0025, 0,    0,    0,    0,    0,    0,    0,
               0,    0,    0,    0,    0,    0,    0,     0,     0.004, 0,    0,    0,    0,    0,    0,
               0,    0,    0,    0,    0,    0,    0,     0,     0,    0.001, 0,    0,    0,    0,    0,
               0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0.001, 0,    0,    0,    0,
               0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0.002, 0,    0,    0,
               0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0.001, 0,    0,
               0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0.001, 0,
               0,    0,    0,    0,    0,    0,    0,     0,     0,    0,    0,    0,    0,    0,    0.0015]
          </rosparam>
     </node>

</launch>
